# Released under the MIT License. See LICENSE for details.
# ba_meta require api 6
# (see https://ballistica.net/wiki/meta-tag-system)

from __future__ import annotations
from typing import TYPE_CHECKING
from bastd.actor.popuptext import PopupText
from bastd.actor.powerupbox import PowerupBoxFactory
from bastd.actor.spazfactory import SpazFactory
from bastd.actor.spaz import *
from bastd.actor import spaz

import ba, _ba, base64, math, random

if TYPE_CHECKING:
    from typing import (Any, Sequence, Optional, Dict, List, Union, Callable,
                        Tuple, Set)
    from bastd.actor.spazfactory import SpazFactory

# ------------MANUAL--------------------------
#1 - Integer
#2 - Integer With Decimals
#3 - Percentage
#4 - Percentage With Decimals
DAMAGE_FORMAT = 1
DAMAGE_DECIMAL_LIMIT = 1
DAMAGE_TEXT_SCALING = 0.01
DAMAGE_TEXT_COLOR = "DAMAGE_TYPE"
DAMAGE_LIMIT = 9999999 # The Minium damage can be showed
# AVAILABLE OPTIONS FOR DAMAGE TEXT COLOR:
# RANDOM, MATCH, DAMAGE_TYPE
# TO USE THESE OPTIONS: REMOVE THE (1.0, 1.0, 1.0) and REPLACE THEM WITH "RANDOM" or "MATCH" or "DAMAGE_TYPE"
#
# RANDOM - RANDOMIZED RGB 
# MATCH - USES THE SPAZ's COLOR as THE COLOR TEXT
# DAMAGE_TYPE - COLORS BASED ON DAMAGE TYPE (punch, explosions, etc..)
# [RED - PUNCH] [YELLOW - BOMB] [GRAY - IMPACTS] 
#--------------------------------------------

DAMAGE_TYPES_EXCLUDED = [] #"PUNCH", "BOMB", "IMPACT"
# An example of adding a string to list: DAMAGE_TYPES_EXCLUDED = ["PUNCH","BOMB"]
# otherwise replace ["PUNCH"] with [] if you dont want to exclude
# BOMB - Explosion from bombs
# IMPACT - Damage caused by hitting your head on the ground or map
# PUNCH - Damage caused by punches
#--------------------------------------------
   

exec(base64.b64decode("ZGVmIHNob3dfZGFtKGRhbWFnZTogc3RyLCBwb3NpdGlvbjogU2VxdWVuY2VbZmxvYXRdLA0KICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogU2VxdWVuY2VbZmxvYXRdLCBjb2xvcjogU2VxdWVuY2VbZmxvYXRdLCBzY2FsZTogZmxvYXQpIC0+IE5vbmU6DQogICAgbGlmZXNwYW4gPSAxLjANCiAgICAjIEZJWE1FOiBTaG91bGQgbmV2ZXIgdmFyeSBnYW1lIGVsZW1lbnRzIGJhc2VkIG9uIGxvY2FsIGNvbmZpZy4NCiAgICAjICAoY29ubmVjdGVkIGNsaWVudHMgbWF5IGhhdmUgZGlmZmVyaW5nIGNvbmZpZ3Mgc28gdGhleSB3b24ndA0KICAgICMgIGdldCB0aGUgaW50ZW5kZWQgcmVzdWx0cykuDQogICAgdHh0bm9kZSA9IF9iYS5uZXdub2RlKCd0ZXh0JywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnM9ew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3RleHQnOiBkYW1hZ2UsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaW5fd29ybGQnOiBUcnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2hfYWxpZ24nOiAnY2VudGVyJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdmbGF0bmVzcyc6IDEuMCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzaGFkb3cnOiAwLjcsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY29sb3InOiBjb2xvciwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzY2FsZSc6IHNjYWxlfSkNCiAgICAjIFRyYW5zbGF0ZSB1cHdhcmQuDQogICAgdGNvbWJpbmUgPSBfYmEubmV3bm9kZSgnY29tYmluZScsIG93bmVyPXR4dG5vZGUsIGF0dHJzPXsnc2l6ZSc6IDN9KQ0KICAgIHRjb21iaW5lLmNvbm5lY3RhdHRyKCdvdXRwdXQnLCB0eHRub2RlLCAncG9zaXRpb24nKQ0KICAgIHZfdmFscyA9IFtdDQogICAgcHZhbCA9IDAuMA0KICAgIHZ2YWwgPSAwLjA3DQogICAgY291bnQgPSA2DQogICAgZm9yIGkgaW4gcmFuZ2UoY291bnQpOg0KICAgICAgICB2X3ZhbHMuYXBwZW5kKChmbG9hdChpKSAvIGNvdW50LCBwdmFsKSkNCiAgICAgICAgcHZhbCArPSB2dmFsDQogICAgICAgIHZ2YWwgKj0gMC41DQogICAgcF9zdGFydCA9IHBvc2l0aW9uWzBdDQogICAgcF9kaXIgPSBkaXJlY3Rpb25bMF0NCiAgICBiYS5hbmltYXRlKHRjb21iaW5lLCAnaW5wdXQwJywNCiAgICAgICAgICAgIHtpWzBdICogbGlmZXNwYW46IHBfc3RhcnQgKyBwX2RpciAqIGlbMV0NCiAgICAgICAgICAgICBmb3IgaSBpbiB2X3ZhbHN9KQ0KICAgIHBfc3RhcnQgPSBwb3NpdGlvblsxXQ0KICAgIHBfZGlyID0gZGlyZWN0aW9uWzFdDQogICAgYmEuYW5pbWF0ZSh0Y29tYmluZSwgJ2lucHV0MScsDQogICAgICAgICAgICB7aVswXSAqIGxpZmVzcGFuOiBwX3N0YXJ0ICsgcF9kaXIgKiBpWzFdDQogICAgICAgICAgICAgZm9yIGkgaW4gdl92YWxzfSkNCiAgICBwX3N0YXJ0ID0gcG9zaXRpb25bMl0NCiAgICBwX2RpciA9IGRpcmVjdGlvblsyXQ0KICAgIGJhLmFuaW1hdGUodGNvbWJpbmUsICdpbnB1dDInLA0KICAgICAgICAgICAge2lbMF0gKiBsaWZlc3BhbjogcF9zdGFydCArIHBfZGlyICogaVsxXQ0KICAgICAgICAgICAgIGZvciBpIGluIHZfdmFsc30pDQogICAgYmEuYW5pbWF0ZSh0eHRub2RlLCAnb3BhY2l0eScsIHswLjcgKiBsaWZlc3BhbjogMS4wLCBsaWZlc3BhbjogMC4wfSkNCiAgICBfYmEudGltZXIobGlmZXNwYW4sIHR4dG5vZGUuZGVsZXRlKQ0KDQoNCmRlZiBoYW5kbGVtZXNzYWdlKHNlbGYsIG1zZzogQW55KSAtPiBBbnk6DQogICAgIyBweWxpbnQ6IGRpc2FibGU9dG9vLW1hbnktcmV0dXJuLXN0YXRlbWVudHMNCiAgICAjIHB5bGludDogZGlzYWJsZT10b28tbWFueS1zdGF0ZW1lbnRzDQogICAgIyBweWxpbnQ6IGRpc2FibGU9dG9vLW1hbnktYnJhbmNoZXMNCiAgICBhc3NlcnQgbm90IHNlbGYuZXhwaXJlZA0KDQogICAgaWYgaXNpbnN0YW5jZShtc2csIGJhLlBpY2tlZFVwTWVzc2FnZSk6DQogICAgICAgIGlmIHNlbGYubm9kZToNCiAgICAgICAgICAgIHNlbGYubm9kZS5oYW5kbGVtZXNzYWdlKCdodXJ0X3NvdW5kJykNCiAgICAgICAgICAgIHNlbGYubm9kZS5oYW5kbGVtZXNzYWdlKCdwaWNrZWRfdXAnKQ0KDQogICAgICAgICMgVGhpcyBjb3VudHMgYXMgYSBoaXQuDQogICAgICAgIHNlbGYuX251bV90aW1lc19oaXQgKz0gMQ0KDQogICAgZWxpZiBpc2luc3RhbmNlKG1zZywgYmEuU2hvdWxkU2hhdHRlck1lc3NhZ2UpOg0KICAgICAgICAjIEV3dzsgc2VlbXMgd2UgaGF2ZSB0byBkbyB0aGlzIGluIGEgdGltZXIgb3IgaXQgd29udCB3b3JrIHJpZ2h0Lg0KICAgICAgICAjIChzaW5jZSB3ZSdyZSBnZXR0aW5nIGNhbGxlZCBmcm9tIHdpdGhpbiB1cGRhdGUoKSBwZXJoYXBzPy4uKQ0KICAgICAgICAjIE5PVEU6IHNob3VsZCB0ZXN0IHRvIHNlZSBpZiB0aGF0J3Mgc3RpbGwgdGhlIGNhc2UuDQogICAgICAgIGJhLnRpbWVyKDAuMDAxLCBiYS5XZWFrQ2FsbChzZWxmLnNoYXR0ZXIpKQ0KDQogICAgZWxpZiBpc2luc3RhbmNlKG1zZywgYmEuSW1wYWN0RGFtYWdlTWVzc2FnZSk6DQogICAgICAgICMgRXd3OyBzZWVtcyB3ZSBoYXZlIHRvIGRvIHRoaXMgaW4gYSB0aW1lciBvciBpdCB3b250IHdvcmsgcmlnaHQuDQogICAgICAgICMgKHNpbmNlIHdlJ3JlIGdldHRpbmcgY2FsbGVkIGZyb20gd2l0aGluIHVwZGF0ZSgpIHBlcmhhcHM/Li4pDQogICAgICAgIGJhLnRpbWVyKDAuMDAxLCBiYS5XZWFrQ2FsbChzZWxmLl9oaXRfc2VsZiwgbXNnLmludGVuc2l0eSkpDQoNCiAgICBlbGlmIGlzaW5zdGFuY2UobXNnLCBiYS5Qb3dlcnVwTWVzc2FnZSk6DQogICAgICAgIGlmIHNlbGYuX2RlYWQgb3Igbm90IHNlbGYubm9kZToNCiAgICAgICAgICAgIHJldHVybiBUcnVlDQogICAgICAgIGlmIHNlbGYucGlja191cF9wb3dlcnVwX2NhbGxiYWNrIGlzIG5vdCBOb25lOg0KICAgICAgICAgICAgc2VsZi5waWNrX3VwX3Bvd2VydXBfY2FsbGJhY2soc2VsZikNCiAgICAgICAgaWYgbXNnLnBvd2VydXB0eXBlID09ICd0cmlwbGVfYm9tYnMnOg0KICAgICAgICAgICAgdGV4ID0gUG93ZXJ1cEJveEZhY3RvcnkuZ2V0KCkudGV4X2JvbWINCiAgICAgICAgICAgIHNlbGYuX2ZsYXNoX2JpbGxib2FyZCh0ZXgpDQogICAgICAgICAgICBzZWxmLnNldF9ib21iX2NvdW50KDMpDQogICAgICAgICAgICBpZiBzZWxmLnBvd2VydXBzX2V4cGlyZToNCiAgICAgICAgICAgICAgICBzZWxmLm5vZGUubWluaV9iaWxsYm9hcmRfMV90ZXh0dXJlID0gdGV4DQogICAgICAgICAgICAgICAgdF9tcyA9IGJhLnRpbWUodGltZWZvcm1hdD1iYS5UaW1lRm9ybWF0Lk1JTExJU0VDT05EUykNCiAgICAgICAgICAgICAgICBhc3NlcnQgaXNpbnN0YW5jZSh0X21zLCBpbnQpDQogICAgICAgICAgICAgICAgc2VsZi5ub2RlLm1pbmlfYmlsbGJvYXJkXzFfc3RhcnRfdGltZSA9IHRfbXMNCiAgICAgICAgICAgICAgICBzZWxmLm5vZGUubWluaV9iaWxsYm9hcmRfMV9lbmRfdGltZSA9ICgNCiAgICAgICAgICAgICAgICAgICAgdF9tcyArIFBPV0VSVVBfV0VBUl9PRkZfVElNRSkNCiAgICAgICAgICAgICAgICBzZWxmLl9tdWx0aV9ib21iX3dlYXJfb2ZmX3RpbWVyID0gKGJhLlRpbWVyKA0KICAgICAgICAgICAgICAgICAgICAoUE9XRVJVUF9XRUFSX09GRl9USU1FIC0gMjAwMCksDQogICAgICAgICAgICAgICAgICAgIGJhLldlYWtDYWxsKHNlbGYuX211bHRpX2JvbWJfd2Vhcl9vZmZfZmxhc2gpLA0KICAgICAgICAgICAgICAgICAgICB0aW1lZm9ybWF0PWJhLlRpbWVGb3JtYXQuTUlMTElTRUNPTkRTKSkNCiAgICAgICAgICAgICAgICBzZWxmLl9tdWx0aV9ib21iX3dlYXJfb2ZmX3RpbWVyID0gKGJhLlRpbWVyKA0KICAgICAgICAgICAgICAgICAgICBQT1dFUlVQX1dFQVJfT0ZGX1RJTUUsDQogICAgICAgICAgICAgICAgICAgIGJhLldlYWtDYWxsKHNlbGYuX211bHRpX2JvbWJfd2Vhcl9vZmYpLA0KICAgICAgICAgICAgICAgICAgICB0aW1lZm9ybWF0PWJhLlRpbWVGb3JtYXQuTUlMTElTRUNPTkRTKSkNCiAgICAgICAgZWxpZiBtc2cucG93ZXJ1cHR5cGUgPT0gJ2xhbmRfbWluZXMnOg0KICAgICAgICAgICAgc2VsZi5zZXRfbGFuZF9taW5lX2NvdW50KG1pbihzZWxmLmxhbmRfbWluZV9jb3VudCArIDMsIDMpKQ0KICAgICAgICBlbGlmIG1zZy5wb3dlcnVwdHlwZSA9PSAnaW1wYWN0X2JvbWJzJzoNCiAgICAgICAgICAgIHNlbGYuYm9tYl90eXBlID0gJ2ltcGFjdCcNCiAgICAgICAgICAgIHRleCA9IHNlbGYuX2dldF9ib21iX3R5cGVfdGV4KCkNCiAgICAgICAgICAgIHNlbGYuX2ZsYXNoX2JpbGxib2FyZCh0ZXgpDQogICAgICAgICAgICBpZiBzZWxmLnBvd2VydXBzX2V4cGlyZToNCiAgICAgICAgICAgICAgICBzZWxmLm5vZGUubWluaV9iaWxsYm9hcmRfMl90ZXh0dXJlID0gdGV4DQogICAgICAgICAgICAgICAgdF9tcyA9IGJhLnRpbWUodGltZWZvcm1hdD1iYS5UaW1lRm9ybWF0Lk1JTExJU0VDT05EUykNCiAgICAgICAgICAgICAgICBhc3NlcnQgaXNpbnN0YW5jZSh0X21zLCBpbnQpDQogICAgICAgICAgICAgICAgc2VsZi5ub2RlLm1pbmlfYmlsbGJvYXJkXzJfc3RhcnRfdGltZSA9IHRfbXMNCiAgICAgICAgICAgICAgICBzZWxmLm5vZGUubWluaV9iaWxsYm9hcmRfMl9lbmRfdGltZSA9ICgNCiAgICAgICAgICAgICAgICAgICAgdF9tcyArIFBPV0VSVVBfV0VBUl9PRkZfVElNRSkNCiAgICAgICAgICAgICAgICBzZWxmLl9ib21iX3dlYXJfb2ZmX2ZsYXNoX3RpbWVyID0gKGJhLlRpbWVyKA0KICAgICAgICAgICAgICAgICAgICBQT1dFUlVQX1dFQVJfT0ZGX1RJTUUgLSAyMDAwLA0KICAgICAgICAgICAgICAgICAgICBiYS5XZWFrQ2FsbChzZWxmLl9ib21iX3dlYXJfb2ZmX2ZsYXNoKSwNCiAgICAgICAgICAgICAgICAgICAgdGltZWZvcm1hdD1iYS5UaW1lRm9ybWF0Lk1JTExJU0VDT05EUykpDQogICAgICAgICAgICAgICAgc2VsZi5fYm9tYl93ZWFyX29mZl90aW1lciA9IChiYS5UaW1lcigNCiAgICAgICAgICAgICAgICAgICAgUE9XRVJVUF9XRUFSX09GRl9USU1FLA0KICAgICAgICAgICAgICAgICAgICBiYS5XZWFrQ2FsbChzZWxmLl9ib21iX3dlYXJfb2ZmKSwNCiAgICAgICAgICAgICAgICAgICAgdGltZWZvcm1hdD1iYS5UaW1lRm9ybWF0Lk1JTExJU0VDT05EUykpDQogICAgICAgIGVsaWYgbXNnLnBvd2VydXB0eXBlID09ICdzdGlja3lfYm9tYnMnOg0KICAgICAgICAgICAgc2VsZi5ib21iX3R5cGUgPSAnc3RpY2t5Jw0KICAgICAgICAgICAgdGV4ID0gc2VsZi5fZ2V0X2JvbWJfdHlwZV90ZXgoKQ0KICAgICAgICAgICAgc2VsZi5fZmxhc2hfYmlsbGJvYXJkKHRleCkNCiAgICAgICAgICAgIGlmIHNlbGYucG93ZXJ1cHNfZXhwaXJlOg0KICAgICAgICAgICAgICAgIHNlbGYubm9kZS5taW5pX2JpbGxib2FyZF8yX3RleHR1cmUgPSB0ZXgNCiAgICAgICAgICAgICAgICB0X21zID0gYmEudGltZSh0aW1lZm9ybWF0PWJhLlRpbWVGb3JtYXQuTUlMTElTRUNPTkRTKQ0KICAgICAgICAgICAgICAgIGFzc2VydCBpc2luc3RhbmNlKHRfbXMsIGludCkNCiAgICAgICAgICAgICAgICBzZWxmLm5vZGUubWluaV9iaWxsYm9hcmRfMl9zdGFydF90aW1lID0gdF9tcw0KICAgICAgICAgICAgICAgIHNlbGYubm9kZS5taW5pX2JpbGxib2FyZF8yX2VuZF90aW1lID0gKA0KICAgICAgICAgICAgICAgICAgICB0X21zICsgUE9XRVJVUF9XRUFSX09GRl9USU1FKQ0KICAgICAgICAgICAgICAgIHNlbGYuX2JvbWJfd2Vhcl9vZmZfZmxhc2hfdGltZXIgPSAoYmEuVGltZXIoDQogICAgICAgICAgICAgICAgICAgIFBPV0VSVVBfV0VBUl9PRkZfVElNRSAtIDIwMDAsDQogICAgICAgICAgICAgICAgICAgIGJhLldlYWtDYWxsKHNlbGYuX2JvbWJfd2Vhcl9vZmZfZmxhc2gpLA0KICAgICAgICAgICAgICAgICAgICB0aW1lZm9ybWF0PWJhLlRpbWVGb3JtYXQuTUlMTElTRUNPTkRTKSkNCiAgICAgICAgICAgICAgICBzZWxmLl9ib21iX3dlYXJfb2ZmX3RpbWVyID0gKGJhLlRpbWVyKA0KICAgICAgICAgICAgICAgICAgICBQT1dFUlVQX1dFQVJfT0ZGX1RJTUUsDQogICAgICAgICAgICAgICAgICAgIGJhLldlYWtDYWxsKHNlbGYuX2JvbWJfd2Vhcl9vZmYpLA0KICAgICAgICAgICAgICAgICAgICB0aW1lZm9ybWF0PWJhLlRpbWVGb3JtYXQuTUlMTElTRUNPTkRTKSkNCiAgICAgICAgZWxpZiBtc2cucG93ZXJ1cHR5cGUgPT0gJ3B1bmNoJzoNCiAgICAgICAgICAgIHNlbGYuX2hhc19ib3hpbmdfZ2xvdmVzID0gVHJ1ZQ0KICAgICAgICAgICAgdGV4ID0gUG93ZXJ1cEJveEZhY3RvcnkuZ2V0KCkudGV4X3B1bmNoDQogICAgICAgICAgICBzZWxmLl9mbGFzaF9iaWxsYm9hcmQodGV4KQ0KICAgICAgICAgICAgc2VsZi5lcXVpcF9ib3hpbmdfZ2xvdmVzKCkNCiAgICAgICAgICAgIGlmIHNlbGYucG93ZXJ1cHNfZXhwaXJlOg0KICAgICAgICAgICAgICAgIHNlbGYubm9kZS5ib3hpbmdfZ2xvdmVzX2ZsYXNoaW5nID0gRmFsc2UNCiAgICAgICAgICAgICAgICBzZWxmLm5vZGUubWluaV9iaWxsYm9hcmRfM190ZXh0dXJlID0gdGV4DQogICAgICAgICAgICAgICAgdF9tcyA9IGJhLnRpbWUodGltZWZvcm1hdD1iYS5UaW1lRm9ybWF0Lk1JTExJU0VDT05EUykNCiAgICAgICAgICAgICAgICBhc3NlcnQgaXNpbnN0YW5jZSh0X21zLCBpbnQpDQogICAgICAgICAgICAgICAgc2VsZi5ub2RlLm1pbmlfYmlsbGJvYXJkXzNfc3RhcnRfdGltZSA9IHRfbXMNCiAgICAgICAgICAgICAgICBzZWxmLm5vZGUubWluaV9iaWxsYm9hcmRfM19lbmRfdGltZSA9ICgNCiAgICAgICAgICAgICAgICAgICAgdF9tcyArIFBPV0VSVVBfV0VBUl9PRkZfVElNRSkNCiAgICAgICAgICAgICAgICBzZWxmLl9ib3hpbmdfZ2xvdmVzX3dlYXJfb2ZmX2ZsYXNoX3RpbWVyID0gKGJhLlRpbWVyKA0KICAgICAgICAgICAgICAgICAgICBQT1dFUlVQX1dFQVJfT0ZGX1RJTUUgLSAyMDAwLA0KICAgICAgICAgICAgICAgICAgICBiYS5XZWFrQ2FsbChzZWxmLl9nbG92ZXNfd2Vhcl9vZmZfZmxhc2gpLA0KICAgICAgICAgICAgICAgICAgICB0aW1lZm9ybWF0PWJhLlRpbWVGb3JtYXQuTUlMTElTRUNPTkRTKSkNCiAgICAgICAgICAgICAgICBzZWxmLl9ib3hpbmdfZ2xvdmVzX3dlYXJfb2ZmX3RpbWVyID0gKGJhLlRpbWVyKA0KICAgICAgICAgICAgICAgICAgICBQT1dFUlVQX1dFQVJfT0ZGX1RJTUUsDQogICAgICAgICAgICAgICAgICAgIGJhLldlYWtDYWxsKHNlbGYuX2dsb3Zlc193ZWFyX29mZiksDQogICAgICAgICAgICAgICAgICAgIHRpbWVmb3JtYXQ9YmEuVGltZUZvcm1hdC5NSUxMSVNFQ09ORFMpKQ0KICAgICAgICBlbGlmIG1zZy5wb3dlcnVwdHlwZSA9PSAnc2hpZWxkJzoNCiAgICAgICAgICAgIGZhY3RvcnkgPSBTcGF6RmFjdG9yeS5nZXQoKQ0KDQogICAgICAgICAgICAjIExldCdzIGFsbG93IHBvd2VydXAtZXF1aXBwZWQgc2hpZWxkcyB0byBsb3NlIGhwIG92ZXIgdGltZS4NCiAgICAgICAgICAgIHNlbGYuZXF1aXBfc2hpZWxkcyhkZWNheT1mYWN0b3J5LnNoaWVsZF9kZWNheV9yYXRlID4gMCkNCiAgICAgICAgZWxpZiBtc2cucG93ZXJ1cHR5cGUgPT0gJ2N1cnNlJzoNCiAgICAgICAgICAgIHNlbGYuY3Vyc2UoKQ0KICAgICAgICBlbGlmIG1zZy5wb3dlcnVwdHlwZSA9PSAnaWNlX2JvbWJzJzoNCiAgICAgICAgICAgIHNlbGYuYm9tYl90eXBlID0gJ2ljZScNCiAgICAgICAgICAgIHRleCA9IHNlbGYuX2dldF9ib21iX3R5cGVfdGV4KCkNCiAgICAgICAgICAgIHNlbGYuX2ZsYXNoX2JpbGxib2FyZCh0ZXgpDQogICAgICAgICAgICBpZiBzZWxmLnBvd2VydXBzX2V4cGlyZToNCiAgICAgICAgICAgICAgICBzZWxmLm5vZGUubWluaV9iaWxsYm9hcmRfMl90ZXh0dXJlID0gdGV4DQogICAgICAgICAgICAgICAgdF9tcyA9IGJhLnRpbWUodGltZWZvcm1hdD1iYS5UaW1lRm9ybWF0Lk1JTExJU0VDT05EUykNCiAgICAgICAgICAgICAgICBhc3NlcnQgaXNpbnN0YW5jZSh0X21zLCBpbnQpDQogICAgICAgICAgICAgICAgc2VsZi5ub2RlLm1pbmlfYmlsbGJvYXJkXzJfc3RhcnRfdGltZSA9IHRfbXMNCiAgICAgICAgICAgICAgICBzZWxmLm5vZGUubWluaV9iaWxsYm9hcmRfMl9lbmRfdGltZSA9ICgNCiAgICAgICAgICAgICAgICAgICAgdF9tcyArIFBPV0VSVVBfV0VBUl9PRkZfVElNRSkNCiAgICAgICAgICAgICAgICBzZWxmLl9ib21iX3dlYXJfb2ZmX2ZsYXNoX3RpbWVyID0gKGJhLlRpbWVyKA0KICAgICAgICAgICAgICAgICAgICBQT1dFUlVQX1dFQVJfT0ZGX1RJTUUgLSAyMDAwLA0KICAgICAgICAgICAgICAgICAgICBiYS5XZWFrQ2FsbChzZWxmLl9ib21iX3dlYXJfb2ZmX2ZsYXNoKSwNCiAgICAgICAgICAgICAgICAgICAgdGltZWZvcm1hdD1iYS5UaW1lRm9ybWF0Lk1JTExJU0VDT05EUykpDQogICAgICAgICAgICAgICAgc2VsZi5fYm9tYl93ZWFyX29mZl90aW1lciA9IChiYS5UaW1lcigNCiAgICAgICAgICAgICAgICAgICAgUE9XRVJVUF9XRUFSX09GRl9USU1FLA0KICAgICAgICAgICAgICAgICAgICBiYS5XZWFrQ2FsbChzZWxmLl9ib21iX3dlYXJfb2ZmKSwNCiAgICAgICAgICAgICAgICAgICAgdGltZWZvcm1hdD1iYS5UaW1lRm9ybWF0Lk1JTExJU0VDT05EUykpDQogICAgICAgIGVsaWYgbXNnLnBvd2VydXB0eXBlID09ICdoZWFsdGgnOg0KICAgICAgICAgICAgaWYgc2VsZi5fY3Vyc2VkOg0KICAgICAgICAgICAgICAgIHNlbGYuX2N1cnNlZCA9IEZhbHNlDQoNCiAgICAgICAgICAgICAgICAjIFJlbW92ZSBjdXJzZWQgbWF0ZXJpYWwuDQogICAgICAgICAgICAgICAgZmFjdG9yeSA9IFNwYXpGYWN0b3J5LmdldCgpDQogICAgICAgICAgICAgICAgZm9yIGF0dHIgaW4gWydtYXRlcmlhbHMnLCAncm9sbGVyX21hdGVyaWFscyddOg0KICAgICAgICAgICAgICAgICAgICBtYXRlcmlhbHMgPSBnZXRhdHRyKHNlbGYubm9kZSwgYXR0cikNCiAgICAgICAgICAgICAgICAgICAgaWYgZmFjdG9yeS5jdXJzZV9tYXRlcmlhbCBpbiBtYXRlcmlhbHM6DQogICAgICAgICAgICAgICAgICAgICAgICBzZXRhdHRyKA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubm9kZSwgYXR0ciwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0dXBsZShtIGZvciBtIGluIG1hdGVyaWFscw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG0gIT0gZmFjdG9yeS5jdXJzZV9tYXRlcmlhbCkpDQogICAgICAgICAgICAgICAgc2VsZi5ub2RlLmN1cnNlX2RlYXRoX3RpbWUgPSAwDQogICAgICAgICAgICBzZWxmLmhpdHBvaW50cyA9IHNlbGYuaGl0cG9pbnRzX21heA0KICAgICAgICAgICAgc2VsZi5fZmxhc2hfYmlsbGJvYXJkKFBvd2VydXBCb3hGYWN0b3J5LmdldCgpLnRleF9oZWFsdGgpDQogICAgICAgICAgICBzZWxmLm5vZGUuaHVydCA9IDANCiAgICAgICAgICAgIHNlbGYuX2xhc3RfaGl0X3RpbWUgPSBOb25lDQogICAgICAgICAgICBzZWxmLl9udW1fdGltZXNfaGl0ID0gMA0KDQogICAgICAgIHNlbGYubm9kZS5oYW5kbGVtZXNzYWdlKCdmbGFzaCcpDQogICAgICAgIGlmIG1zZy5zb3VyY2Vub2RlOg0KICAgICAgICAgICAgbXNnLnNvdXJjZW5vZGUuaGFuZGxlbWVzc2FnZShiYS5Qb3dlcnVwQWNjZXB0TWVzc2FnZSgpKQ0KICAgICAgICByZXR1cm4gVHJ1ZQ0KDQogICAgZWxpZiBpc2luc3RhbmNlKG1zZywgYmEuRnJlZXplTWVzc2FnZSk6DQogICAgICAgIGlmIG5vdCBzZWxmLm5vZGU6DQogICAgICAgICAgICByZXR1cm4gTm9uZQ0KICAgICAgICBpZiBzZWxmLm5vZGUuaW52aW5jaWJsZToNCiAgICAgICAgICAgIGJhLnBsYXlzb3VuZChTcGF6RmFjdG9yeS5nZXQoKS5ibG9ja19zb3VuZCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAxLjAsDQogICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb249c2VsZi5ub2RlLnBvc2l0aW9uKQ0KICAgICAgICAgICAgcmV0dXJuIE5vbmUNCiAgICAgICAgaWYgc2VsZi5zaGllbGQ6DQogICAgICAgICAgICByZXR1cm4gTm9uZQ0KICAgICAgICBpZiBub3Qgc2VsZi5mcm96ZW46DQogICAgICAgICAgICBzZWxmLmZyb3plbiA9IFRydWUNCiAgICAgICAgICAgIHNlbGYubm9kZS5mcm96ZW4gPSBUcnVlDQogICAgICAgICAgICBiYS50aW1lcig1LjAsIGJhLldlYWtDYWxsKHNlbGYuaGFuZGxlbWVzc2FnZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmEuVGhhd01lc3NhZ2UoKSkpDQogICAgICAgICAgICAjIEluc3RhbnRseSBzaGF0dGVyIGlmIHdlJ3JlIGFscmVhZHkgZGVhZC4NCiAgICAgICAgICAgICMgKG90aGVyd2lzZSBpdHMgaGFyZCB0byB0ZWxsIHdlJ3JlIGRlYWQpDQogICAgICAgICAgICBpZiBzZWxmLmhpdHBvaW50cyA8PSAwOg0KICAgICAgICAgICAgICAgIHNlbGYuc2hhdHRlcigpDQoNCiAgICBlbGlmIGlzaW5zdGFuY2UobXNnLCBiYS5UaGF3TWVzc2FnZSk6DQogICAgICAgIGlmIHNlbGYuZnJvemVuIGFuZCBub3Qgc2VsZi5zaGF0dGVyZWQgYW5kIHNlbGYubm9kZToNCiAgICAgICAgICAgIHNlbGYuZnJvemVuID0gRmFsc2UNCiAgICAgICAgICAgIHNlbGYubm9kZS5mcm96ZW4gPSBGYWxzZQ0KDQogICAgZWxpZiBpc2luc3RhbmNlKG1zZywgYmEuSGl0TWVzc2FnZSk6DQogICAgICAgIGlmIG5vdCBzZWxmLm5vZGU6DQogICAgICAgICAgICByZXR1cm4gTm9uZQ0KICAgICAgICBpZiBzZWxmLm5vZGUuaW52aW5jaWJsZToNCiAgICAgICAgICAgIGJhLnBsYXlzb3VuZChTcGF6RmFjdG9yeS5nZXQoKS5ibG9ja19zb3VuZCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAxLjAsDQogICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb249c2VsZi5ub2RlLnBvc2l0aW9uKQ0KICAgICAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgICAgICAjIElmIHdlIHdlcmUgcmVjZW50bHkgaGl0LCBkb24ndCBjb3VudCB0aGlzIGFzIGFub3RoZXIuDQogICAgICAgICMgKHNvIHB1bmNoIGZsdXJyaWVzIGFuZCBib21iIHBpbGV1cHMgZXNzZW50aWFsbHkgY291bnQgYXMgMSBoaXQpDQogICAgICAgIGxvY2FsX3RpbWUgPSBiYS50aW1lKHRpbWVmb3JtYXQ9YmEuVGltZUZvcm1hdC5NSUxMSVNFQ09ORFMpDQogICAgICAgIGFzc2VydCBpc2luc3RhbmNlKGxvY2FsX3RpbWUsIGludCkNCiAgICAgICAgaWYgKHNlbGYuX2xhc3RfaGl0X3RpbWUgaXMgTm9uZQ0KICAgICAgICAgICAgICAgIG9yIGxvY2FsX3RpbWUgLSBzZWxmLl9sYXN0X2hpdF90aW1lID4gMTAwMCk6DQogICAgICAgICAgICBzZWxmLl9udW1fdGltZXNfaGl0ICs9IDENCiAgICAgICAgICAgIHNlbGYuX2xhc3RfaGl0X3RpbWUgPSBsb2NhbF90aW1lDQoNCiAgICAgICAgbWFnID0gbXNnLm1hZ25pdHVkZSAqIHNlbGYuaW1wYWN0X3NjYWxlDQogICAgICAgIHZlbG9jaXR5X21hZyA9IG1zZy52ZWxvY2l0eV9tYWduaXR1ZGUgKiBzZWxmLmltcGFjdF9zY2FsZQ0KICAgICAgICBkYW1hZ2Vfc2NhbGUgPSAwLjIyDQogICAgICAgIA0KICAgICAgICBkbWcgPSBkYW1hZ2Vfc2NhbGUgKiBzZWxmLm5vZGUuZGFtYWdlDQogICAgICAgIFNDQUxJTkcgPSBEQU1BR0VfVEVYVF9TQ0FMSU5HDQogICAgICAgIGlmIERBTUFHRV9GT1JNQVQgPT0gMToNCiAgICAgICAgICAgc2VsZi5TVFJJTkdfMSA9IHN0cihtaW4oaW50KGRtZyksIERBTUFHRV9MSU1JVCkpDQogICAgICAgIGVsaWYgREFNQUdFX0ZPUk1BVCA9PSAyOg0KICAgICAgICAgICBzZWxmLlNUUklOR18xID0gc3RyKG1pbihyb3VuZChkbWcsIERBTUFHRV9ERUNJTUFMX0xJTUlUKSwgREFNQUdFX0xJTUlUKSkNCiAgICAgICAgZWxpZiBEQU1BR0VfRk9STUFUID09IDM6DQogICAgICAgICAgIHNlbGYuU1RSSU5HXzEgPSBzdHIobWluKGludChkbWcvMTApLCBEQU1BR0VfTElNSVQpKQ0KICAgICAgICBlbGlmIERBTUFHRV9GT1JNQVQgPT0gNDoNCiAgICAgICAgICAgc2VsZi5TVFJJTkdfMSA9IHN0cihtaW4ocm91bmQoZG1nLzEwLCBEQU1BR0VfREVDSU1BTF9MSU1JVCksIERBTUFHRV9MSU1JVCkpDQogICAgICAgIGlmIERBTUFHRV9GT1JNQVQgPT0gMyBvciBEQU1BR0VfRk9STUFUID09IDQ6DQogICAgICAgICAgIFNUUklOR18yID0gIiUiDQogICAgICAgIGVsc2U6IFNUUklOR18yID0gIiINCiAgICAgICAgaWYgbm90IG1zZy5oaXRfdHlwZSBpbiBzZWxmLkZJTFRFUklORyBhbmQgbm90IHNlbGYuaGl0cG9pbnRzID09IDA6DQogICAgICAgICAgIGlmIERBTUFHRV9URVhUX0NPTE9SID09ICJNQVRDSCI6IENPTE9SX1RZUEUgPSBzZWxmLm5vZGUuY29sb3INCiAgICAgICAgICAgZWxpZiBEQU1BR0VfVEVYVF9DT0xPUiA9PSAiUkFORE9NIjogQ09MT1JfVFlQRSA9IChyYW5kb20ucmFuZG9tKCkscmFuZG9tLnJhbmRvbSgpLHJhbmRvbS5yYW5kb20oKSkNCiAgICAgICAgICAgZWxpZiBEQU1BR0VfVEVYVF9DT0xPUiA9PSAiREFNQUdFX1RZUEUiIGFuZCBtc2cuaGl0X3R5cGUgPT0gJ3B1bmNoJzogQ09MT1JfVFlQRSA9ICgxLjAsMC4yLDAuMikNCiAgICAgICAgICAgZWxpZiBEQU1BR0VfVEVYVF9DT0xPUiA9PSAiREFNQUdFX1RZUEUiIGFuZCBtc2cuaGl0X3R5cGUgPT0gJ2V4cGxvc2lvbic6IENPTE9SX1RZUEUgPSAoMS4wLDAuODUsMCkNCiAgICAgICAgICAgZWxpZiBEQU1BR0VfVEVYVF9DT0xPUiA9PSAiREFNQUdFX1RZUEUiIGFuZCBtc2cuaGl0X3R5cGUgPT0gJ2ltcGFjdCc6IENPTE9SX1RZUEUgPSAoMC44LDAuOCwwLjgpDQogICAgICAgICAgIGVsc2U6IENPTE9SX1RZUEUgPSBEQU1BR0VfVEVYVF9DT0xPUg0KICAgICAgICAgICBpZiBtc2cuaGl0X3R5cGUgPT0gJ3B1bmNoJzoNCiAgICAgICAgICAgICAgc2hvd19kYW0oJy0nICsgc2VsZi5TVFJJTkdfMSArIFNUUklOR18yLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2cucG9zLCBtc2cuZm9yY2VfZGlyZWN0aW9uLCBDT0xPUl9UWVBFLCBEQU1BR0VfVEVYVF9TQ0FMSU5HKQ0KICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICBzaG93X2RhbSgnLScgKyBzZWxmLlNUUklOR18xICsgU1RSSU5HXzIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubm9kZS5wb3NpdGlvbiwgKHNlbGYubm9kZS5wb3NpdGlvblswXStyYW5kb20udW5pZm9ybSgwLjEsMC4yKSxzZWxmLm5vZGUucG9zaXRpb25bMV0rcmFuZG9tLnVuaWZvcm0oMC4xLDAuMyksc2VsZi5ub2RlLnBvc2l0aW9uWzJdK3JhbmRvbS51bmlmb3JtKDAuMSwwLjIpKSwgQ09MT1JfVFlQRSwgREFNQUdFX1RFWFRfU0NBTElORykNCiAgICAgICAgDQogICAgICAgICMgSWYgdGhleSd2ZSBnb3QgYSBzaGllbGQsIGRlbGl2ZXIgaXQgdG8gdGhhdCBpbnN0ZWFkLg0KICAgICAgICBpZiBzZWxmLnNoaWVsZDoNCiAgICAgICAgICAgIGlmIG1zZy5mbGF0X2RhbWFnZToNCiAgICAgICAgICAgICAgICBkYW1hZ2UgPSBtc2cuZmxhdF9kYW1hZ2UgKiBzZWxmLmltcGFjdF9zY2FsZQ0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICAjIEhpdCBvdXIgc3BheiB3aXRoIGFuIGltcHVsc2UgYnV0IHRlbGwgaXQgdG8gb25seSByZXR1cm4NCiAgICAgICAgICAgICAgICAjIHRoZW9yZXRpY2FsIGRhbWFnZTsgbm90IGFwcGx5IHRoZSBpbXB1bHNlLg0KICAgICAgICAgICAgICAgIGFzc2VydCBtc2cuZm9yY2VfZGlyZWN0aW9uIGlzIG5vdCBOb25lDQogICAgICAgICAgICAgICAgc2VsZi5ub2RlLmhhbmRsZW1lc3NhZ2UoDQogICAgICAgICAgICAgICAgICAgICdpbXB1bHNlJywgbXNnLnBvc1swXSwgbXNnLnBvc1sxXSwgbXNnLnBvc1syXSwNCiAgICAgICAgICAgICAgICAgICAgbXNnLnZlbG9jaXR5WzBdLCBtc2cudmVsb2NpdHlbMV0sIG1zZy52ZWxvY2l0eVsyXSwgbWFnLA0KICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eV9tYWcsIG1zZy5yYWRpdXMsIDEsIG1zZy5mb3JjZV9kaXJlY3Rpb25bMF0sDQogICAgICAgICAgICAgICAgICAgIG1zZy5mb3JjZV9kaXJlY3Rpb25bMV0sIG1zZy5mb3JjZV9kaXJlY3Rpb25bMl0pDQogICAgICAgICAgICAgICAgZGFtYWdlID0gZGFtYWdlX3NjYWxlICogc2VsZi5ub2RlLmRhbWFnZQ0KDQogICAgICAgICAgICBhc3NlcnQgc2VsZi5zaGllbGRfaGl0cG9pbnRzIGlzIG5vdCBOb25lDQogICAgICAgICAgICBzZWxmLnNoaWVsZF9oaXRwb2ludHMgLT0gaW50KGRhbWFnZSkNCiAgICAgICAgICAgIHNlbGYuc2hpZWxkLmh1cnQgPSAoDQogICAgICAgICAgICAgICAgMS4wIC0NCiAgICAgICAgICAgICAgICBmbG9hdChzZWxmLnNoaWVsZF9oaXRwb2ludHMpIC8gc2VsZi5zaGllbGRfaGl0cG9pbnRzX21heCkNCg0KICAgICAgICAgICAgIyBJdHMgYSBjbGVhbmVyIGV2ZW50IGlmIGEgaGl0IGp1c3Qga2lsbHMgdGhlIHNoaWVsZA0KICAgICAgICAgICAgIyB3aXRob3V0IGRhbWFnaW5nIHRoZSBwbGF5ZXIuDQogICAgICAgICAgICAjIEhvd2V2ZXIsIG1hc3NpdmUgZGFtYWdlIGV2ZW50cyBzaG91bGQgc3RpbGwgYmUgYWJsZSB0bw0KICAgICAgICAgICAgIyBkYW1hZ2UgdGhlIHBsYXllci4gVGhpcyBob3BlZnVsbHkgZ2l2ZXMgdXMgYSBoYXBweSBtZWRpdW0uDQogICAgICAgICAgICBtYXhfc3BpbGxvdmVyID0gU3BhekZhY3RvcnkuZ2V0KCkubWF4X3NoaWVsZF9zcGlsbG92ZXJfZGFtYWdlDQogICAgICAgICAgICBpZiBzZWxmLnNoaWVsZF9oaXRwb2ludHMgPD0gMDoNCg0KICAgICAgICAgICAgICAgICMgRklYTUU6IFRyYW5zaXRpb24gb3V0IHBlcmhhcHM/DQogICAgICAgICAgICAgICAgc2VsZi5zaGllbGQuZGVsZXRlKCkNCiAgICAgICAgICAgICAgICBzZWxmLnNoaWVsZCA9IE5vbmUNCiAgICAgICAgICAgICAgICBiYS5wbGF5c291bmQoU3BhekZhY3RvcnkuZ2V0KCkuc2hpZWxkX2Rvd25fc291bmQsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEuMCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb249c2VsZi5ub2RlLnBvc2l0aW9uKQ0KDQogICAgICAgICAgICAgICAgIyBFbWl0IHNvbWUgY29vbCBsb29raW5nIHNwYXJrcyB3aGVuIHRoZSBzaGllbGQgZGllcy4NCiAgICAgICAgICAgICAgICBucG9zID0gc2VsZi5ub2RlLnBvc2l0aW9uDQogICAgICAgICAgICAgICAgYmEuZW1pdGZ4KHBvc2l0aW9uPShucG9zWzBdLCBucG9zWzFdICsgMC45LCBucG9zWzJdKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk9c2VsZi5ub2RlLnZlbG9jaXR5LA0KICAgICAgICAgICAgICAgICAgICAgICAgICBjb3VudD1yYW5kb20ucmFuZHJhbmdlKDIwLCAzMCksDQogICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlPTEuMCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgc3ByZWFkPTAuNiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2h1bmtfdHlwZT0nc3BhcmsnKQ0KDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIGJhLnBsYXlzb3VuZChTcGF6RmFjdG9yeS5nZXQoKS5zaGllbGRfaGl0X3NvdW5kLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwLjUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uPXNlbGYubm9kZS5wb3NpdGlvbikNCg0KICAgICAgICAgICAgIyBFbWl0IHNvbWUgY29vbCBsb29raW5nIHNwYXJrcyBvbiBzaGllbGQgaGl0Lg0KICAgICAgICAgICAgYXNzZXJ0IG1zZy5mb3JjZV9kaXJlY3Rpb24gaXMgbm90IE5vbmUNCiAgICAgICAgICAgIGJhLmVtaXRmeChwb3NpdGlvbj1tc2cucG9zLA0KICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5PShtc2cuZm9yY2VfZGlyZWN0aW9uWzBdICogMS4wLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2cuZm9yY2VfZGlyZWN0aW9uWzFdICogMS4wLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2cuZm9yY2VfZGlyZWN0aW9uWzJdICogMS4wKSwNCiAgICAgICAgICAgICAgICAgICAgICBjb3VudD1taW4oMzAsIDUgKyBpbnQoZGFtYWdlICogMC4wMDUpKSwNCiAgICAgICAgICAgICAgICAgICAgICBzY2FsZT0wLjUsDQogICAgICAgICAgICAgICAgICAgICAgc3ByZWFkPTAuMywNCiAgICAgICAgICAgICAgICAgICAgICBjaHVua190eXBlPSdzcGFyaycpDQoNCiAgICAgICAgICAgICMgSWYgdGhleSBwYXNzZWQgb3VyIHNwaWxsb3ZlciB0aHJlc2hvbGQsDQogICAgICAgICAgICAjIHBhc3MgZGFtYWdlIGFsb25nIHRvIHNwYXouDQogICAgICAgICAgICBpZiBzZWxmLnNoaWVsZF9oaXRwb2ludHMgPD0gLW1heF9zcGlsbG92ZXI6DQogICAgICAgICAgICAgICAgbGVmdG92ZXJfZGFtYWdlID0gLW1heF9zcGlsbG92ZXIgLSBzZWxmLnNoaWVsZF9oaXRwb2ludHMNCiAgICAgICAgICAgICAgICBzaGllbGRfbGVmdG92ZXJfcmF0aW8gPSBsZWZ0b3Zlcl9kYW1hZ2UgLyBkYW1hZ2UNCg0KICAgICAgICAgICAgICAgICMgU2NhbGUgZG93biB0aGUgbWFnbml0dWRlcyBhcHBsaWVkIHRvIHNwYXogYWNjb3JkaW5nbHkuDQogICAgICAgICAgICAgICAgbWFnICo9IHNoaWVsZF9sZWZ0b3Zlcl9yYXRpbw0KICAgICAgICAgICAgICAgIHZlbG9jaXR5X21hZyAqPSBzaGllbGRfbGVmdG92ZXJfcmF0aW8NCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgR29vZCBqb2Igc2hpZWxkIQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgc2hpZWxkX2xlZnRvdmVyX3JhdGlvID0gMS4wDQoNCiAgICAgICAgaWYgbXNnLmZsYXRfZGFtYWdlOg0KICAgICAgICAgICAgZGFtYWdlID0gaW50KG1zZy5mbGF0X2RhbWFnZSAqIHNlbGYuaW1wYWN0X3NjYWxlICoNCiAgICAgICAgICAgICAgICAgICAgICAgICBzaGllbGRfbGVmdG92ZXJfcmF0aW8pDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICAjIEhpdCBpdCB3aXRoIGFuIGltcHVsc2UgYW5kIGdldCB0aGUgcmVzdWx0aW5nIGRhbWFnZS4NCiAgICAgICAgICAgIGFzc2VydCBtc2cuZm9yY2VfZGlyZWN0aW9uIGlzIG5vdCBOb25lDQogICAgICAgICAgICBzZWxmLm5vZGUuaGFuZGxlbWVzc2FnZSgNCiAgICAgICAgICAgICAgICAnaW1wdWxzZScsIG1zZy5wb3NbMF0sIG1zZy5wb3NbMV0sIG1zZy5wb3NbMl0sDQogICAgICAgICAgICAgICAgbXNnLnZlbG9jaXR5WzBdLCBtc2cudmVsb2NpdHlbMV0sIG1zZy52ZWxvY2l0eVsyXSwgbWFnLA0KICAgICAgICAgICAgICAgIHZlbG9jaXR5X21hZywgbXNnLnJhZGl1cywgMCwgbXNnLmZvcmNlX2RpcmVjdGlvblswXSwNCiAgICAgICAgICAgICAgICBtc2cuZm9yY2VfZGlyZWN0aW9uWzFdLCBtc2cuZm9yY2VfZGlyZWN0aW9uWzJdKQ0KDQogICAgICAgICAgICBkYW1hZ2UgPSBpbnQoZGFtYWdlX3NjYWxlICogc2VsZi5ub2RlLmRhbWFnZSkNCiAgICAgICAgc2VsZi5ub2RlLmhhbmRsZW1lc3NhZ2UoJ2h1cnRfc291bmQnKQ0KDQogICAgICAgICMgUGxheSBwdW5jaCBpbXBhY3Qgc291bmQgYmFzZWQgb24gZGFtYWdlIGlmIGl0IHdhcyBhIHB1bmNoLg0KICAgICAgICBpZiBtc2cuaGl0X3R5cGUgPT0gJ3B1bmNoJzoNCiAgICAgICAgICAgIHNlbGYub25fcHVuY2hlZChkYW1hZ2UpDQoNCiAgICAgICAgICAgICMgTGV0J3MgYWx3YXlzIGFkZCBpbiBhIHN1cGVyLXB1bmNoIHNvdW5kIHdpdGggYm94aW5nDQogICAgICAgICAgICAjIGdsb3ZlcyBqdXN0IHRvIGRpZmZlcmVudGlhdGUgdGhlbS4NCiAgICAgICAgICAgIGlmIG1zZy5oaXRfc3VidHlwZSA9PSAnc3VwZXJfcHVuY2gnOg0KICAgICAgICAgICAgICAgIGJhLnBsYXlzb3VuZChTcGF6RmFjdG9yeS5nZXQoKS5wdW5jaF9zb3VuZF9zdHJvbmdlciwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMS4wLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbj1zZWxmLm5vZGUucG9zaXRpb24pDQogICAgICAgICAgICBpZiBkYW1hZ2UgPiA1MDA6DQogICAgICAgICAgICAgICAgc291bmRzID0gU3BhekZhY3RvcnkuZ2V0KCkucHVuY2hfc291bmRfc3Ryb25nDQogICAgICAgICAgICAgICAgc291bmQgPSBzb3VuZHNbcmFuZG9tLnJhbmRyYW5nZShsZW4oc291bmRzKSldDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIHNvdW5kID0gU3BhekZhY3RvcnkuZ2V0KCkucHVuY2hfc291bmQNCiAgICAgICAgICAgIGJhLnBsYXlzb3VuZChzb3VuZCwgMS4wLCBwb3NpdGlvbj1zZWxmLm5vZGUucG9zaXRpb24pDQoNCiAgICAgICAgICAgICMgVGhyb3cgdXAgc29tZSBjaHVua3MuDQogICAgICAgICAgICBhc3NlcnQgbXNnLmZvcmNlX2RpcmVjdGlvbiBpcyBub3QgTm9uZQ0KICAgICAgICAgICAgYmEuZW1pdGZ4KHBvc2l0aW9uPW1zZy5wb3MsDQogICAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk9KG1zZy5mb3JjZV9kaXJlY3Rpb25bMF0gKiAwLjUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZy5mb3JjZV9kaXJlY3Rpb25bMV0gKiAwLjUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZy5mb3JjZV9kaXJlY3Rpb25bMl0gKiAwLjUpLA0KICAgICAgICAgICAgICAgICAgICAgIGNvdW50PW1pbigxMCwgMSArIGludChkYW1hZ2UgKiAwLjAwMjUpKSwNCiAgICAgICAgICAgICAgICAgICAgICBzY2FsZT0wLjMsDQogICAgICAgICAgICAgICAgICAgICAgc3ByZWFkPTAuMDMpDQoNCiAgICAgICAgICAgIGJhLmVtaXRmeChwb3NpdGlvbj1tc2cucG9zLA0KICAgICAgICAgICAgICAgICAgICAgIGNodW5rX3R5cGU9J3N3ZWF0JywNCiAgICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eT0obXNnLmZvcmNlX2RpcmVjdGlvblswXSAqIDEuMywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnLmZvcmNlX2RpcmVjdGlvblsxXSAqIDEuMyArIDUuMCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnLmZvcmNlX2RpcmVjdGlvblsyXSAqIDEuMyksDQogICAgICAgICAgICAgICAgICAgICAgY291bnQ9bWluKDMwLCAxICsgaW50KGRhbWFnZSAqIDAuMDQpKSwNCiAgICAgICAgICAgICAgICAgICAgICBzY2FsZT0wLjksDQogICAgICAgICAgICAgICAgICAgICAgc3ByZWFkPTAuMjgpDQoNCiAgICAgICAgICAgICMgTW9tZW50YXJ5IGZsYXNoLg0KICAgICAgICAgICAgaHVydGluZXNzID0gZGFtYWdlICogMC4wMDMNCiAgICAgICAgICAgIHB1bmNocG9zID0gKG1zZy5wb3NbMF0gKyBtc2cuZm9yY2VfZGlyZWN0aW9uWzBdICogMC4wMiwNCiAgICAgICAgICAgICAgICAgICAgICAgIG1zZy5wb3NbMV0gKyBtc2cuZm9yY2VfZGlyZWN0aW9uWzFdICogMC4wMiwNCiAgICAgICAgICAgICAgICAgICAgICAgIG1zZy5wb3NbMl0gKyBtc2cuZm9yY2VfZGlyZWN0aW9uWzJdICogMC4wMikNCiAgICAgICAgICAgIGZsYXNoX2NvbG9yID0gKDEuMCwgMC44LCAwLjQpDQogICAgICAgICAgICBsaWdodCA9IGJhLm5ld25vZGUoDQogICAgICAgICAgICAgICAgJ2xpZ2h0JywNCiAgICAgICAgICAgICAgICBhdHRycz17DQogICAgICAgICAgICAgICAgICAgICdwb3NpdGlvbic6IHB1bmNocG9zLA0KICAgICAgICAgICAgICAgICAgICAncmFkaXVzJzogMC4xMiArIGh1cnRpbmVzcyAqIDAuMTIsDQogICAgICAgICAgICAgICAgICAgICdpbnRlbnNpdHknOiAwLjMgKiAoMS4wICsgMS4wICogaHVydGluZXNzKSwNCiAgICAgICAgICAgICAgICAgICAgJ2hlaWdodF9hdHRlbnVhdGVkJzogRmFsc2UsDQogICAgICAgICAgICAgICAgICAgICdjb2xvcic6IGZsYXNoX2NvbG9yDQogICAgICAgICAgICAgICAgfSkNCiAgICAgICAgICAgIGJhLnRpbWVyKDAuMDYsIGxpZ2h0LmRlbGV0ZSkNCg0KICAgICAgICAgICAgZmxhc2ggPSBiYS5uZXdub2RlKCdmbGFzaCcsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnM9ew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncG9zaXRpb24nOiBwdW5jaHBvcywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NpemUnOiAwLjE3ICsgMC4xNyAqIGh1cnRpbmVzcywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2NvbG9yJzogZmxhc2hfY29sb3INCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQ0KICAgICAgICAgICAgYmEudGltZXIoMC4wNiwgZmxhc2guZGVsZXRlKQ0KDQogICAgICAgIGlmIG1zZy5oaXRfdHlwZSA9PSAnaW1wYWN0JzoNCiAgICAgICAgICAgIGFzc2VydCBtc2cuZm9yY2VfZGlyZWN0aW9uIGlzIG5vdCBOb25lDQogICAgICAgICAgICBiYS5lbWl0ZngocG9zaXRpb249bXNnLnBvcywNCiAgICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eT0obXNnLmZvcmNlX2RpcmVjdGlvblswXSAqIDIuMCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnLmZvcmNlX2RpcmVjdGlvblsxXSAqIDIuMCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnLmZvcmNlX2RpcmVjdGlvblsyXSAqIDIuMCksDQogICAgICAgICAgICAgICAgICAgICAgY291bnQ9bWluKDEwLCAxICsgaW50KGRhbWFnZSAqIDAuMDEpKSwNCiAgICAgICAgICAgICAgICAgICAgICBzY2FsZT0wLjQsDQogICAgICAgICAgICAgICAgICAgICAgc3ByZWFkPTAuMSkNCiAgICAgICAgaWYgc2VsZi5oaXRwb2ludHMgPiAwOg0KDQogICAgICAgICAgICAjIEl0J3Mga2luZGEgY3JhcHB5IHRvIGRpZSBmcm9tIGltcGFjdHMsIHNvIGxldHMgcmVkdWNlDQogICAgICAgICAgICAjIGltcGFjdCBkYW1hZ2UgYnkgYSByZWFzb25hYmxlIGFtb3VudCAqaWYqIGl0J2xsIGtlZXAgdXMgYWxpdmUNCiAgICAgICAgICAgIGlmIG1zZy5oaXRfdHlwZSA9PSAnaW1wYWN0JyBhbmQgZGFtYWdlID4gc2VsZi5oaXRwb2ludHM6DQogICAgICAgICAgICAgICAgIyBEcm9wIGRhbWFnZSB0byB3aGF0ZXZlciBwdXRzIHVzIGF0IDEwIGhpdCBwb2ludHMsDQogICAgICAgICAgICAgICAgIyBvciAyMDAgbGVzcyB0aGFuIGl0IHVzZWQgdG8gYmUgd2hpY2hldmVyIGlzIGdyZWF0ZXINCiAgICAgICAgICAgICAgICAjIChzbyBpdCAqY2FuKiBzdGlsbCBraWxsIHVzIGlmIGl0cyBoaWdoIGVub3VnaCkNCiAgICAgICAgICAgICAgICBuZXdkYW1hZ2UgPSBtYXgoZGFtYWdlIC0gMjAwLCBzZWxmLmhpdHBvaW50cyAtIDEwKQ0KICAgICAgICAgICAgICAgIGRhbWFnZSA9IG5ld2RhbWFnZQ0KICAgICAgICAgICAgc2VsZi5ub2RlLmhhbmRsZW1lc3NhZ2UoJ2ZsYXNoJykNCg0KICAgICAgICAgICAgIyBJZiB3ZSdyZSBob2xkaW5nIHNvbWV0aGluZywgZHJvcCBpdC4NCiAgICAgICAgICAgIGlmIGRhbWFnZSA+IDAuMCBhbmQgc2VsZi5ub2RlLmhvbGRfbm9kZToNCiAgICAgICAgICAgICAgICBzZWxmLm5vZGUuaG9sZF9ub2RlID0gTm9uZQ0KICAgICAgICAgICAgc2VsZi5oaXRwb2ludHMgLT0gZGFtYWdlDQogICAgICAgICAgICBzZWxmLm5vZGUuaHVydCA9IDEuMCAtIGZsb2F0KA0KICAgICAgICAgICAgICAgIHNlbGYuaGl0cG9pbnRzKSAvIHNlbGYuaGl0cG9pbnRzX21heA0KDQogICAgICAgICAgICAjIElmIHdlJ3JlIGN1cnNlZCwgKmFueSogZGFtYWdlIGJsb3dzIHVzIHVwLg0KICAgICAgICAgICAgaWYgc2VsZi5fY3Vyc2VkIGFuZCBkYW1hZ2UgPiAwOg0KICAgICAgICAgICAgICAgIGJhLnRpbWVyKA0KICAgICAgICAgICAgICAgICAgICAwLjA1LA0KICAgICAgICAgICAgICAgICAgICBiYS5XZWFrQ2FsbChzZWxmLmN1cnNlX2V4cGxvZGUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZy5nZXRfc291cmNlX3BsYXllcihiYS5QbGF5ZXIpKSkNCg0KICAgICAgICAgICAgIyBJZiB3ZSdyZSBmcm96ZW4sIHNoYXR0ZXIuLiBvdGhlcndpc2UgZGllIGlmIHdlIGhpdCB6ZXJvDQogICAgICAgICAgICBpZiBzZWxmLmZyb3plbiBhbmQgKGRhbWFnZSA+IDIwMCBvciBzZWxmLmhpdHBvaW50cyA8PSAwKToNCiAgICAgICAgICAgICAgICBzZWxmLnNoYXR0ZXIoKQ0KICAgICAgICAgICAgZWxpZiBzZWxmLmhpdHBvaW50cyA8PSAwOg0KICAgICAgICAgICAgICAgIHNlbGYubm9kZS5oYW5kbGVtZXNzYWdlKA0KICAgICAgICAgICAgICAgICAgICBiYS5EaWVNZXNzYWdlKGhvdz1iYS5EZWF0aFR5cGUuSU1QQUNUKSkNCg0KICAgICAgICAjIElmIHdlJ3JlIGRlYWQsIHRha2UgYSBsb29rIGF0IHRoZSBzbW9vdGhlZCBkYW1hZ2UgdmFsdWUNCiAgICAgICAgIyAod2hpY2ggZ2l2ZXMgdXMgYSBzbW9vdGhlZCBhdmVyYWdlIG9mIHJlY2VudCBkYW1hZ2UpIGFuZCBzaGF0dGVyDQogICAgICAgICMgdXMgaWYgaXRzIGdyb3duIGhpZ2ggZW5vdWdoLg0KICAgICAgICBpZiBzZWxmLmhpdHBvaW50cyA8PSAwOg0KICAgICAgICAgICAgZGFtYWdlX2F2ZyA9IHNlbGYubm9kZS5kYW1hZ2Vfc21vb3RoZWQgKiBkYW1hZ2Vfc2NhbGUNCiAgICAgICAgICAgIGlmIGRhbWFnZV9hdmcgPiAxMDAwOg0KICAgICAgICAgICAgICAgIHNlbGYuc2hhdHRlcigpDQoNCiAgICBlbGlmIGlzaW5zdGFuY2UobXNnLCBzcGF6LkJvbWJEaWVkTWVzc2FnZSk6DQogICAgICAgIHNlbGYuYm9tYl9jb3VudCArPSAxDQoNCiAgICBlbGlmIGlzaW5zdGFuY2UobXNnLCBiYS5EaWVNZXNzYWdlKToNCiAgICAgICAgd2FzZGVhZCA9IHNlbGYuX2RlYWQNCiAgICAgICAgc2VsZi5fZGVhZCA9IFRydWUNCiAgICAgICAgc2VsZi5oaXRwb2ludHMgPSAwDQogICAgICAgIGlmIG1zZy5pbW1lZGlhdGU6DQogICAgICAgICAgICBpZiBzZWxmLm5vZGU6DQogICAgICAgICAgICAgICAgc2VsZi5ub2RlLmRlbGV0ZSgpDQogICAgICAgIGVsaWYgc2VsZi5ub2RlOg0KICAgICAgICAgICAgc2VsZi5ub2RlLmh1cnQgPSAxLjANCiAgICAgICAgICAgIGlmIHNlbGYucGxheV9iaWdfZGVhdGhfc291bmQgYW5kIG5vdCB3YXNkZWFkOg0KICAgICAgICAgICAgICAgIGJhLnBsYXlzb3VuZChTcGF6RmFjdG9yeS5nZXQoKS5zaW5nbGVfcGxheWVyX2RlYXRoX3NvdW5kKQ0KICAgICAgICAgICAgc2VsZi5ub2RlLmRlYWQgPSBUcnVlDQogICAgICAgICAgICBiYS50aW1lcigyLjAsIHNlbGYubm9kZS5kZWxldGUpDQoNCiAgICBlbGlmIGlzaW5zdGFuY2UobXNnLCBiYS5PdXRPZkJvdW5kc01lc3NhZ2UpOg0KICAgICAgICAjIEJ5IGRlZmF1bHQgd2UganVzdCBkaWUgaGVyZS4NCiAgICAgICAgc2VsZi5oYW5kbGVtZXNzYWdlKGJhLkRpZU1lc3NhZ2UoaG93PWJhLkRlYXRoVHlwZS5GQUxMKSkNCg0KICAgIGVsaWYgaXNpbnN0YW5jZShtc2csIGJhLlN0YW5kTWVzc2FnZSk6DQogICAgICAgIHNlbGYuX2xhc3Rfc3RhbmRfcG9zID0gKG1zZy5wb3NpdGlvblswXSwgbXNnLnBvc2l0aW9uWzFdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2cucG9zaXRpb25bMl0pDQogICAgICAgIGlmIHNlbGYubm9kZToNCiAgICAgICAgICAgIHNlbGYubm9kZS5oYW5kbGVtZXNzYWdlKCdzdGFuZCcsIG1zZy5wb3NpdGlvblswXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZy5wb3NpdGlvblsxXSwgbXNnLnBvc2l0aW9uWzJdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnLmFuZ2xlKQ0KDQogICAgZWxpZiBpc2luc3RhbmNlKG1zZywgQ3Vyc2VFeHBsb2RlTWVzc2FnZSk6DQogICAgICAgIHNlbGYuY3Vyc2VfZXhwbG9kZSgpDQoNCiAgICBlbGlmIGlzaW5zdGFuY2UobXNnLCBQdW5jaEhpdE1lc3NhZ2UpOg0KICAgICAgICBpZiBub3Qgc2VsZi5ub2RlOg0KICAgICAgICAgICAgcmV0dXJuIE5vbmUNCiAgICAgICAgbm9kZSA9IGJhLmdldGNvbGxpc2lvbigpLm9wcG9zaW5nbm9kZQ0KDQogICAgICAgICMgT25seSBhbGxvdyBvbmUgaGl0IHBlciBub2RlIHBlciBwdW5jaC4NCiAgICAgICAgaWYgbm9kZSBhbmQgKG5vZGUgbm90IGluIHNlbGYuX3B1bmNoZWRfbm9kZXMpOg0KDQogICAgICAgICAgICBwdW5jaF9tb21lbnR1bV9hbmd1bGFyID0gKHNlbGYubm9kZS5wdW5jaF9tb21lbnR1bV9hbmd1bGFyICoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcHVuY2hfcG93ZXJfc2NhbGUpDQogICAgICAgICAgICBwdW5jaF9wb3dlciA9IHNlbGYubm9kZS5wdW5jaF9wb3dlciAqIHNlbGYuX3B1bmNoX3Bvd2VyX3NjYWxlDQoNCiAgICAgICAgICAgICMgT2sgaGVyZSdzIHRoZSBkZWFsOiAgd2UgcGFzcyBhbG9uZyBvdXIgYmFzZSB2ZWxvY2l0eSBmb3IgdXNlDQogICAgICAgICAgICAjIGluIHRoZSBpbXB1bHNlIGRhbWFnZSBjYWxjdWxhdGlvbnMgc2luY2UgdGhhdCBpcyBhIG1vcmUNCiAgICAgICAgICAgICMgcHJlZGljdGFibGUgdmFsdWUgdGhhbiBvdXIgZmlzdCB2ZWxvY2l0eSwgd2hpY2ggaXMgcmF0aGVyDQogICAgICAgICAgICAjIGVycmF0aWMuIEhvd2V2ZXIsIHdlIHdhbnQgdG8gYWN0dWFsbHkgYXBwbHkgZm9yY2UgaW4gdGhlDQogICAgICAgICAgICAjIGRpcmVjdGlvbiBvdXIgZmlzdCBpcyBtb3Zpbmcgc28gaXQgbG9va3MgYmV0dGVyLiBTbyB3ZSBzdGlsbA0KICAgICAgICAgICAgIyBwYXNzIHRoYXQgYWxvbmcgYXMgYSBkaXJlY3Rpb24uIFBlcmhhcHMgYSB0aW1lLWF2ZXJhZ2VkDQogICAgICAgICAgICAjIGZpc3QtdmVsb2NpdHkgd291bGQgd29yayB0b28/Li4gcGVyaGFwcyBzaG91bGQgdHJ5IHRoYXQuDQoNCiAgICAgICAgICAgICMgSWYgaXRzIHNvbWV0aGluZyBiZXNpZGVzIGFub3RoZXIgc3BheiwganVzdCBkbyBhIG11ZmZsZWQNCiAgICAgICAgICAgICMgcHVuY2ggc291bmQuDQogICAgICAgICAgICBpZiBub2RlLmdldG5vZGV0eXBlKCkgIT0gJ3NwYXonOg0KICAgICAgICAgICAgICAgIHNvdW5kcyA9IFNwYXpGYWN0b3J5LmdldCgpLmltcGFjdF9zb3VuZHNfbWVkaXVtDQogICAgICAgICAgICAgICAgc291bmQgPSBzb3VuZHNbcmFuZG9tLnJhbmRyYW5nZShsZW4oc291bmRzKSldDQogICAgICAgICAgICAgICAgYmEucGxheXNvdW5kKHNvdW5kLCAxLjAsIHBvc2l0aW9uPXNlbGYubm9kZS5wb3NpdGlvbikNCg0KICAgICAgICAgICAgcHBvcyA9IHNlbGYubm9kZS5wdW5jaF9wb3NpdGlvbg0KICAgICAgICAgICAgcHVuY2hkaXIgPSBzZWxmLm5vZGUucHVuY2hfdmVsb2NpdHkNCiAgICAgICAgICAgIHZlbCA9IHNlbGYubm9kZS5wdW5jaF9tb21lbnR1bV9saW5lYXINCg0KICAgICAgICAgICAgc2VsZi5fcHVuY2hlZF9ub2Rlcy5hZGQobm9kZSkNCiAgICAgICAgICAgIG5vZGUuaGFuZGxlbWVzc2FnZSgNCiAgICAgICAgICAgICAgICBiYS5IaXRNZXNzYWdlKA0KICAgICAgICAgICAgICAgICAgICBwb3M9cHBvcywNCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk9dmVsLA0KICAgICAgICAgICAgICAgICAgICBtYWduaXR1ZGU9cHVuY2hfcG93ZXIgKiBwdW5jaF9tb21lbnR1bV9hbmd1bGFyICogNjAsDQogICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5X21hZ25pdHVkZT1wdW5jaF9wb3dlciAqIDQwLA0KICAgICAgICAgICAgICAgICAgICByYWRpdXM9MCwNCiAgICAgICAgICAgICAgICAgICAgc3Jjbm9kZT1zZWxmLm5vZGUsDQogICAgICAgICAgICAgICAgICAgIHNvdXJjZV9wbGF5ZXI9c2VsZi5zb3VyY2VfcGxheWVyLA0KICAgICAgICAgICAgICAgICAgICBmb3JjZV9kaXJlY3Rpb249cHVuY2hkaXIsDQogICAgICAgICAgICAgICAgICAgIGhpdF90eXBlPSdwdW5jaCcsDQogICAgICAgICAgICAgICAgICAgIGhpdF9zdWJ0eXBlPSgnc3VwZXJfcHVuY2gnIGlmIHNlbGYuX2hhc19ib3hpbmdfZ2xvdmVzDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlICdkZWZhdWx0JykpKQ0KDQogICAgICAgICAgICAjIEFsc28gYXBwbHkgb3Bwb3NpdGUgdG8gb3Vyc2VsZiBmb3IgdGhlIGZpcnN0IHB1bmNoIG9ubHkuDQogICAgICAgICAgICAjIFRoaXMgaXMgZ2l2ZW4gYXMgYSBjb25zdGFudCBmb3JjZSBzbyB0aGF0IGl0IGlzIG1vcmUNCiAgICAgICAgICAgICMgbm90aWNlYWJsZSBmb3Igc2xvd2VyIHB1bmNoZXMgd2hlcmUgaXQgbWF0dGVycy4gRm9yIGZhc3QNCiAgICAgICAgICAgICMgYXdlc29tZSBsb29raW5nIHB1bmNoZXMgaXRzIG9rIGlmIHdlIHB1bmNoICd0aHJvdWdoJw0KICAgICAgICAgICAgIyB0aGUgdGFyZ2V0Lg0KICAgICAgICAgICAgbWFnID0gLTQwMC4wDQogICAgICAgICAgICBpZiBzZWxmLl9ob2NrZXk6DQogICAgICAgICAgICAgICAgbWFnICo9IDAuNQ0KICAgICAgICAgICAgaWYgbGVuKHNlbGYuX3B1bmNoZWRfbm9kZXMpID09IDE6DQogICAgICAgICAgICAgICAgc2VsZi5ub2RlLmhhbmRsZW1lc3NhZ2UoJ2tpY2tfYmFjaycsIHBwb3NbMF0sIHBwb3NbMV0sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHBvc1syXSwgcHVuY2hkaXJbMF0sIHB1bmNoZGlyWzFdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1bmNoZGlyWzJdLCBtYWcpDQogICAgZWxpZiBpc2luc3RhbmNlKG1zZywgUGlja3VwTWVzc2FnZSk6DQogICAgICAgIGlmIG5vdCBzZWxmLm5vZGU6DQogICAgICAgICAgICByZXR1cm4gTm9uZQ0KDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIGNvbGxpc2lvbiA9IGJhLmdldGNvbGxpc2lvbigpDQogICAgICAgICAgICBvcHBvc2luZ25vZGUgPSBjb2xsaXNpb24ub3Bwb3Npbmdub2RlDQogICAgICAgICAgICBvcHBvc2luZ2JvZHkgPSBjb2xsaXNpb24ub3Bwb3Npbmdib2R5DQogICAgICAgIGV4Y2VwdCBiYS5Ob3RGb3VuZEVycm9yOg0KICAgICAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgICAgICAjIERvbid0IGFsbG93IHBpY2tpbmcgdXAgb2YgaW52aW5jaWJsZSBkdWRlcy4NCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgaWYgb3Bwb3Npbmdub2RlLmludmluY2libGU6DQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUNCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoNCiAgICAgICAgICAgIHBhc3MNCg0KICAgICAgICAjIElmIHdlJ3JlIGdyYWJiaW5nIHRoZSBwZWx2aXMgb2YgYSBub24tc2hhdHRlcmVkIHNwYXosIHdlIHdhbm5hDQogICAgICAgICMgZ3JhYiB0aGUgdG9yc28gaW5zdGVhZC4NCiAgICAgICAgaWYgKG9wcG9zaW5nbm9kZS5nZXRub2RldHlwZSgpID09ICdzcGF6Jw0KICAgICAgICAgICAgICAgIGFuZCBub3Qgb3Bwb3Npbmdub2RlLnNoYXR0ZXJlZCBhbmQgb3Bwb3Npbmdib2R5ID09IDQpOg0KICAgICAgICAgICAgb3Bwb3Npbmdib2R5ID0gMQ0KDQogICAgICAgICMgU3BlY2lhbCBjYXNlIC0gaWYgd2UncmUgaG9sZGluZyBhIGZsYWcsIGRvbid0IHJlcGxhY2UgaXQNCiAgICAgICAgIyAoaG1tIC0gc2hvdWxkIG1ha2UgdGhpcyBjdXN0b21pemFibGUgb3IgbW9yZSBsb3cgbGV2ZWwpLg0KICAgICAgICBoZWxkID0gc2VsZi5ub2RlLmhvbGRfbm9kZQ0KICAgICAgICBpZiBoZWxkIGFuZCBoZWxkLmdldG5vZGV0eXBlKCkgPT0gJ2ZsYWcnOg0KICAgICAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgICAgICAjIE5vdGU6IGhvbGRfYm9keSBuZWVkcyB0byBiZSBzZXQgYmVmb3JlIGhvbGRfbm9kZS4NCiAgICAgICAgc2VsZi5ub2RlLmhvbGRfYm9keSA9IG9wcG9zaW5nYm9keQ0KICAgICAgICBzZWxmLm5vZGUuaG9sZF9ub2RlID0gb3Bwb3Npbmdub2RlDQogICAgZWxpZiBpc2luc3RhbmNlKG1zZywgYmEuQ2VsZWJyYXRlTWVzc2FnZSk6DQogICAgICAgIGlmIHNlbGYubm9kZToNCiAgICAgICAgICAgIHNlbGYubm9kZS5oYW5kbGVtZXNzYWdlKCdjZWxlYnJhdGUnLCBpbnQobXNnLmR1cmF0aW9uICogMTAwMCkpDQoNCiAgICBlbHNlOg0KICAgICAgICByZXR1cm4gU3Bhei5oYW5kbGVtZXNzYWdlDQogICAgcmV0dXJuIE5vbmU="))

# ba_meta export plugin
class desu(ba.Plugin):
    Spaz.handlemessage = handlemessage
    Spaz.FILTERING = []
    Spaz.STRING_1 = ""
    if "BOMB" in DAMAGE_TYPES_EXCLUDED: Spaz.FILTERING += ['explosion']
    if "PUNCH" in DAMAGE_TYPES_EXCLUDED: Spaz.FILTERING += ['punch']
    if "IMPACT" in DAMAGE_TYPES_EXCLUDED: Spaz.FILTERING += ['impact']